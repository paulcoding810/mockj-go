name: Build and Push Docker

on:
  release:
    types: [created]
  push:
    branches: [main, ci]
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (optional)"
        required: false
        type: string
        default: "nightly"

jobs:
  build-and-push:
    uses: ./.github/workflows/docker-reusable.yml
    with:
      image_name: mockj
      docker_context: .
      dockerfile: docker/Dockerfile
      version: ${{ github.event.inputs.version || 'nightly' }}
      platforms: linux/amd64,linux/arm64
      push: true
      cache: true
    secrets: inherit

  test-image:
    needs: build-and-push
    uses: ./.github/workflows/test-docker.yml
    with:
      image_ref: ghcr.io/${{ github.repository_owner }}/mockj:${{ github.event.inputs.version || 'latest' }}
      version: ${{ github.event.inputs.version || 'latest' }}

  deploy-docs:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update Docker README
        run: |
          echo "ğŸ“ Updating documentation for release ${{ github.event.release.name }}"
          # Add any documentation update steps here

      - name: Notify deployment
        run: |
          echo "ğŸš€ MockJ-Go ${{ github.event.release.name }} has been deployed!"
          echo "Docker Image: ghcr.io/${{ github.repository_owner }}/mockj:${{ github.event.release.name }}"
          echo "Web Interface: Available at your deployment endpoint"

  notify:
    needs: [build-and-push, test-image]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Build Summary
        run: |
          echo "ğŸ“Š Docker Build & Test Summary"
          echo "==============================="
          echo "Version: ${{ github.event.inputs.version || 'nightly' }}"
          echo "Image: ghcr.io/${{ github.repository_owner }}/mockj:${{ github.event.inputs.version || 'latest' }}"
          echo ""

          if [ "${{ needs.build-and-push.result }}" = "success" ]; then
            echo "âœ… Docker Build: PASSED"
          else
            echo "âŒ Docker Build: FAILED"
          fi

          if [ "${{ needs.test-image.result }}" = "success" ]; then
            echo "âœ… Image Tests: PASSED"
          else
            echo "âŒ Image Tests: FAILED"
          fi

          echo ""
          echo "ğŸŒ Quick Start Commands:"
          echo "docker run -d -p 8080:8080 ghcr.io/${{ github.repository_owner }}/mockj:${{ github.event.inputs.version || 'latest' }}"
          echo "docker-compose up -d"
